# Data Model

This document describes the database schema for the IRC client application.

## Multi-tenancy

This application uses per-user database isolation. Each user has their own SQLite database. The `Tenant` module handles switching between databases.

## Models

### User

Generated by Rails 8 authentication generator.

| Field | Type | Notes |
|-------|------|-------|
| id | integer | Primary key |
| email_address | string | Unique, required |
| password_digest | string | BCrypt hash |
| created_at | datetime | |
| updated_at | datetime | |

### Session

Generated by Rails 8 authentication generator.

| Field | Type | Notes |
|-------|------|-------|
| id | integer | Primary key |
| user_id | integer | FK to users |
| ip_address | string | |
| user_agent | string | |
| created_at | datetime | |
| updated_at | datetime | |

### Server

IRC server configuration.

| Field | Type | Notes |
|-------|------|-------|
| id | integer | Primary key |
| address | string | Required, e.g. "irc.libera.chat" |
| port | integer | Required, default 6697, range 1-65535 |
| ssl | boolean | Default true |
| nickname | string | Required, IRC nick format |
| username | string | Defaults to nickname |
| realname | string | Defaults to nickname |
| auth_method | string | "none", "nickserv", or "sasl" |
| auth_password | string | Encrypted, required if auth_method != "none" |
| created_at | datetime | |
| updated_at | datetime | |

**Validations:**
- address: present
- port: present, numeric, 1-65535
- nickname: present, format `/\A[a-zA-Z][a-zA-Z0-9_\-\[\]\\`^{}]{0,8}\z/`
- auth_password: present if auth_method != "none"

**Associations:**
- has_many :channels
- has_many :messages

### Channel

IRC channel the user has joined.

| Field | Type | Notes |
|-------|------|-------|
| id | integer | Primary key |
| server_id | integer | FK to servers |
| name | string | Required, starts with # or & |
| topic | text | Channel topic |
| last_read_message_id | integer | For unread tracking |
| joined | boolean | Currently in channel |
| created_at | datetime | |
| updated_at | datetime | |

**Validations:**
- name: present, format starts with # or &
- name: unique per server

**Associations:**
- belongs_to :server
- has_many :channel_users
- has_many :messages

### ChannelUser

Tracks who is currently in a channel (for user list).

| Field | Type | Notes |
|-------|------|-------|
| id | integer | Primary key |
| channel_id | integer | FK to channels |
| nickname | string | Required |
| modes | string | e.g. "o" for op, "v" for voice |
| created_at | datetime | |
| updated_at | datetime | |

**Validations:**
- nickname: present
- nickname: unique per channel

**Associations:**
- belongs_to :channel

### Message

IRC message (channel messages, PMs, events).

| Field | Type | Notes |
|-------|------|-------|
| id | integer | Primary key |
| server_id | integer | FK to servers |
| channel_id | integer | FK to channels (null for PMs/server msgs) |
| target | string | For PMs: the other party's nick |
| sender | string | Who sent it |
| content | text | Message content |
| message_type | string | "privmsg", "action", "notice", "join", "part", etc. |
| created_at | datetime | |
| updated_at | datetime | |

**Message Types:**
- privmsg: Regular channel/PM message
- action: /me action
- notice: IRC NOTICE
- join: User joined channel
- part: User left channel
- quit: User quit server
- kick: User was kicked
- nick: User changed nick
- topic: Topic changed
- mode: Mode changed
- server: Server message (MOTD, etc.)

**Associations:**
- belongs_to :server
- belongs_to :channel (optional)
- has_one :notification

### Notification

Tracks highlights and DM notifications.

| Field | Type | Notes |
|-------|------|-------|
| id | integer | Primary key |
| message_id | integer | FK to messages |
| reason | string | "highlight" or "dm" |
| read | boolean | Default false |
| created_at | datetime | |
| updated_at | datetime | |

**Associations:**
- belongs_to :message

## Entity Relationship Diagram

```
User (shared DB)
  |
  +-- Session

Per-User Database:
  Server
    |
    +-- Channel
    |     |
    |     +-- ChannelUser
    |     +-- Message
    |
    +-- Message (PMs/server messages, channel_id null)
          |
          +-- Notification
```
