<% is_channel = messageable.is_a?(Channel) %>
<% is_conversation = messageable.is_a?(Conversation) %>
<% target_offline = is_conversation && !messageable.online? %>
<% can_send = messageable.server.connected? && (!is_channel || messageable.joined) && !target_offline %>
<% if can_send %>
<%= form_with url: is_channel ? channel_messages_path(messageable) : conversation_messages_path(messageable),
              class: "message-input",
              multipart: true,
              data: {
                  controller: "message-form",
                  message_form_message_list_outlet: ".messages",
                  action: "keydown->message-form#handleKeydown message-form#preventEmptySubmit turbo:submit-end->message-form#clearInput",
              }.compact do |f| %>
    <%= f.text_area :content,
        placeholder: "Message #{messageable.display_name}",
        aria: { label: "Message #{messageable.display_name.delete('#')}" },
        rows: 1,
        class: "field",
        data: { message_form_target: "input", controller: "auto-resize", action: "input->auto-resize#resize" } %>
    <% if is_channel %>
      <label class="upload" role="button" aria-label="Attach file">
        ğŸ“
        <input type="file"
               id="file_upload"
               name="message[file]"
               accept="image/png,image/jpeg,image/gif,image/webp"
               aria-label="Attach file"
               data-action="change->message-form#submit"
               data-message-form-target="fileInput"
               hidden>
      </label>
    <% end %>
    <%= f.submit "Send", class: "submit", data: { action: "mousedown->message-form#preventFocusLoss" } %>
  <% end %>
<% elsif target_offline %>
  <div class="message-input">
    <span class="disabled"><%= messageable.target_nick %> is offline.</span>
  </div>
<% elsif is_channel && messageable.server.connected? && !messageable.joined %>
  <div class="message-input">
    <%= text_area_tag :content, nil, placeholder: "Message #{messageable.display_name}", class: "field", rows: 1, disabled: true %>
  </div>
<% else %>
  <div class="message-input">
    <span class="disabled">Connect to server to send messages.</span>
  </div>
<% end %>
