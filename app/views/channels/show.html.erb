<%= turbo_stream_from @channel %>
<%= turbo_stream_from @channel, :users %>

<div class="channel-view" data-controller="channel">
  <header class="header">
    <span class="name"><%= @channel.name %></span>
    <% if @channel.auto_join %>
      <span class="auto-join-badge">auto</span>
    <% end %>
    <%= form_with model: @channel, class: "auto-join-form" do |f| %>
      <label class="auto-join-toggle">
        <%= f.check_box :auto_join, onchange: "this.form.requestSubmit()" %>
        <span>Auto-join</span>
      </label>
    <% end %>
    <span class="topic"><%= @channel.topic %></span>
    <% if @channel.joined %>
      <%= button_to "Leave", channel_path(@channel), method: :delete, class: "leave", data: { turbo_confirm: "Leave #{@channel.name}?" } %>
    <% else %>
      <%= form_with url: server_channels_path(@channel.server), class: "join-form" do |f| %>
        <%= f.hidden_field :name, name: "channel[name]", value: @channel.name %>
        <%= f.submit "Join", class: "join" %>
      <% end %>
    <% end %>
  </header>

  <% unless @channel.joined %>
    <div class="not-joined-banner">
      You are not in this channel. Join to send messages.
    </div>
  <% end %>

  <div class="messages"
       data-controller="message-list"
       data-channel-target="messages"
       data-message-list-channel-id-value="<%= @channel.id %>">
    <div id="messages">
      <%= render partial: "messages/message", collection: @messages %>
    </div>
    <div class="new-messages-indicator hidden" data-message-list-target="newIndicator" data-action="click->message-list#scrollToNew">
      New messages below
    </div>
  </div>

  <div class="input">
    <%= render "messages/form", channel: @channel %>
  </div>
</div>

<% content_for :userlist do %>
  <div id="channel_<%= @channel.id %>_user_list">
    <%= render "channels/user_list", channel: @channel %>
  </div>
<% end %>
